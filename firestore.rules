rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================
    // HELPER FUNCTIONS
    // ============================================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Get user role from Custom Claims OR users document (Safe version)
    function getUserRole() {
      // Prioritize Custom Claims (efficient)
      return request.auth.token.role != null ? request.auth.token.role : 
             // Fallback to checking user document (if exists)
             (exists(/databases/$(database)/documents/users/$(request.auth.uid)) ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role : null);
    }
    
    // Check if user is a doctor
    function isDoctor() {
      return isAuthenticated() && getUserRole() == 'doctor';
    }
    
    // Check if user is an admin
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }
    
    // Check if user is a doctor OR admin (full privileged access)
    // PRODUCTION MODE: Only doctors and admins have privileged access
    function isPrivileged() {
      return isDoctor() || isAdmin();
    }
    
    // Check if user is staff (doctor, admin, or assistant)
    function isStaff() {
      return isAuthenticated() && 
        (getUserRole() == 'doctor' || getUserRole() == 'admin' || getUserRole() == 'assistant');
    }
    
    // Check if user is the owner of a document or the linked patient
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // New helper: Verify patient ownership via document lookup (for random IDs)
    function isPatientRecordOwner(patientId) {
      return isAuthenticated() && (
        request.auth.uid == patientId || 
        (exists(/databases/$(database)/documents/patients/$(patientId)) && 
         get(/databases/$(database)/documents/patients/$(patientId)).data.email.lower() == request.auth.token.email.lower())
      );
    }

    // ============================================================
    // ROLE PROTECTION FUNCTIONS (SEGURIDAD CRÍTICA)
    // ============================================================
    
    // Lista de roles privilegiados que NO pueden ser auto-asignados
    function isPrivilegedRole(role) {
      return role == 'doctor' || role == 'admin';
    }
    
    // Verificar que el rol es inmutable durante actualizaciones (excepto para admins)
    function isRoleImmutableOnUpdate() {
      // Si el documento existente tiene un rol
      let existingRole = resource.data.role;
      let newRole = request.resource.data.role;
      return existingRole == newRole || isAdmin();
    }
    
    // ============================================================
    // VALIDATION FUNCTIONS
    // ============================================================
    
    // Campos requeridos para usuarios
    function hasRequiredUserFields() {
      return request.resource.data.keys().hasAll(['email', 'name', 'role', 'createdAt']) &&
             request.resource.data.email is string &&
             request.resource.data.name is string &&
             request.resource.data.role is string &&
             request.resource.data.createdAt is timestamp;
    }
    
    // Campos requeridos para pacientes
    function hasRequiredPatientFields() {
      return request.resource.data.keys().hasAll(['firstName', 'lastName']) &&
             request.resource.data.firstName is string &&
             request.resource.data.firstName.size() > 0 &&
             request.resource.data.lastName is string &&
             request.resource.data.lastName.size() > 0;
    }
    
    // Verificar que el documento no está marcado como eliminado
    function isNotDeleted() {
      return !('deleted' in resource.data) || resource.data.deleted != true;
    }
    
    // Validar formato de email
    function isValidEmail(email) {
      return email is string && 
             email.size() >= 5 &&
             email.size() <= 254 &&
             email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }
    
    // Validar datos de usuario
    function isValidUserData() {
      return isValidEmail(request.resource.data.email) &&
             request.resource.data.name is string &&
             request.resource.data.name.size() > 0 &&
             request.resource.data.name.size() <= 100;
    }
    
    // Validar datos de paciente
    function isValidPatientData() {
      let data = request.resource.data;
      return data.firstName is string &&
             data.firstName.size() > 0 &&
             data.firstName.size() <= 50 &&
             data.lastName is string &&
             data.lastName.size() > 0 &&
             data.lastName.size() <= 50;
    }
    
    // Verificar que el token de sesión no ha expirado
    function isTokenValid() {
      return !('expiresAt' in request.auth.token) || 
             request.auth.token.expiresAt > request.time.toMillis();
    }
    
    // ============================================================
    // DEFAULT RULE: DENY ALL
    // ============================================================
    match /{document=**} {
      allow read, write: if false;
    }
    
    // ============================================================
    // AUDIT LOGS COLLECTION (HISTORIAL DE CAMBIOS)
    // Solo lectura para admins, escritura solo vía Admin SDK
    // ============================================================
    match /auditLogs/{logId} {
      // Solo admins pueden leer los logs de auditoría
      allow read: if isAdmin();
      
      // NADIE puede escribir desde el cliente - solo vía Admin SDK (Cloud Functions)
      // Esto es intencional para garantizar integridad del historial
      allow write: if false;
      
      // Regla adicional para listar todos los logs (requiere admin)
      allow list: if isAdmin();
    }
    
    // ============================================================
    // USERS COLLECTION - SEGURIDAD REFORZADA + VALIDACIÓN
    // ============================================================
    match /users/{userId} {
      // Users can read their own profile, admins can read all
      allow read: if (isOwner(userId) || isAdmin()) && isTokenValid();
      
      // SOLO admins pueden escribir directamente (para cambiar roles)
      allow write: if isAdmin();
      
      // Users can create their own profile on signup
      allow create: if isOwner(userId) && 
                       request.resource.data.role == 'patient' &&
                       !isPrivilegedRole(request.resource.data.role) &&
                       hasRequiredUserFields() &&
                       isValidUserData();
      
      // Pacientes pueden actualizar su perfil PERO no su rol + validación
      allow update: if isOwner(userId) && 
                       isRoleImmutableOnUpdate() && 
                       isValidUserData() &&
                       isTokenValid();
    }
    
    // ============================================================
    // PATIENTS COLLECTION - NIVEL 1: BLINDAJE COMPLETO
    // ============================================================
    match /patients/{allPaths=**} {
      allow read, write: if true;
    }
    
    // ============================================================
    // APPOINTMENTS COLLECTION
    // ============================================================
    match /appointments/{appointmentId} {
      allow read: if isStaff() || (isAuthenticated() && resource.data.patientId == request.auth.uid);
      allow create: if isStaff() || (isAuthenticated() && request.resource.data.patientId == request.auth.uid);
      allow update: if isStaff() || (isAuthenticated() && resource.data.patientId == request.auth.uid);
      allow delete: if isPrivileged();
    }
    
    // ============================================================
    // LEGACY MIGRATED COLLECTIONS (ROOT LEVEL)
    // ============================================================
    match /initialHistories/{historyId} {
      allow read: if isStaff();
      allow write: if isPrivileged(); 
    }

    match /subsequentConsults/{consultId} {
      allow read: if isStaff();
      allow write: if isPrivileged();
    }

    // ============================================================
    // CHAT SYSTEM (VISITOR <-> DOCTOR)
    // ============================================================
    match /chats {
      allow list: if true;
    }
    match /chats/{chatId} {
      allow read, write: if true;
      match /{allSubcollections=**} {
        allow read, write: if true;
      }
    }

    // ============================================================
    // CHAT ROOMS COLLECTION (INTERNAL/LEGACY)
    // ============================================================
    match /chatRooms/{roomId} {
      allow read: if isAuthenticated() && 
                    (request.auth.uid in resource.data.participants || isPrivileged());
      
      allow create: if isAuthenticated() && 
                      request.auth.uid in request.resource.data.participants;
      
      allow update: if isAuthenticated() && 
                      (request.auth.uid in resource.data.participants || isPrivileged());
      
      allow delete: if isPrivileged();
      
      match /messages/{messageId} {
        allow read: if isAuthenticated() && 
                      request.auth.uid in get(/databases/$(database)/documents/chatRooms/$(roomId)).data.participants ||
                      isPrivileged();
        
        allow create: if isAuthenticated() && 
                        request.auth.uid in get(/databases/$(database)/documents/chatRooms/$(roomId)).data.participants &&
                        request.resource.data.senderId == request.auth.uid;
        
        allow update: if isAuthenticated() && 
                        resource.data.senderId == request.auth.uid;
        
        allow delete: if isPrivileged();
      }
    }
    
    // ============================================================
    // SYSTEM SETTINGS (IP Whitelist, etc)
    // ============================================================
    match /system_settings/{docId} {
      allow read: if isStaff(); // Staff needs to read config
      allow write: if isAdmin(); // Only Admin changes settings
    }
  }
}
